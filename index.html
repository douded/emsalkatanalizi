<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kat Analizi ve ƒ∞ndirgeme Programƒ± v2.1</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --danger: #dc2626;
            --success: #16a34a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1, h2, h3 { color: var(--secondary); margin-bottom: 15px; }
        
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        .row { display: flex; gap: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }

        button {
            cursor: pointer;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        
        .btn-primary { background-color: var(--primary); color: white; width: 100%; font-size: 1.1rem; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-danger { background-color: var(--danger); color: white; padding: 5px 10px; font-size: 0.8rem; }
        .btn-edit { background-color: var(--primary); color: white; padding: 5px 10px; font-size: 0.8rem; margin-right: 5px; }
        
        .floor-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            background: #f8fafc;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }

        .floor-row h4 { margin: 0 0 5px 0; grid-column: 1 / -1; font-size: 0.9rem; color: var(--secondary); }

        @media (max-width: 600px) {
            .floor-row { grid-template-columns: 1fr; }
            .btn-danger { width: 100%; margin-top: 5px; }
        }

        .result-box {
            background-color: #ecfdf5;
            border: 1px solid #10b981;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .record-item {
            border-left: 4px solid var(--primary);
            padding-left: 15px;
            margin-bottom: 15px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            position: relative;
        }
        
        .record-actions { margin-top: 10px; text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèóÔ∏è Kat Analizi Programƒ±</h1>

    <div class="card" id="inputForm">
        <h3>Yeni Analiz Olu≈ütur</h3>
        <input type="hidden" id="editId">
        
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label>ƒ∞stenilen Fiyat (TL)</label>
                    <input type="number" id="askingPrice" placeholder="√ñrn: 10000000">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>Pazarlƒ±k Payƒ± (%) - Opsiyonel</label>
                    <input type="number" id="bargainMargin" placeholder="Bo≈ü bƒ±rakƒ±lƒ±rsa fiyat baz alƒ±nƒ±r">
                </div>
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 20px 0;">

        <h4 style="color: var(--text);">Bina Kat Yapƒ±landƒ±rmasƒ±</h4>
        <div class="row" style="background: #eff6ff; padding: 15px; border-radius: 8px; border: 1px solid #bfdbfe;">
            <div class="col">
                <div class="form-group">
                    <label>Bodrum Kat Sayƒ±sƒ±</label>
                    <input type="number" id="basementCount" value="1" min="0" onchange="updateFloorOptions()" oninput="updateFloorOptions()">
                    <small style="color:#666; font-size:0.8em">Ka√ß adet bodrum kat var?</small>
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>Normal Kat Sayƒ±sƒ±</label>
                    <input type="number" id="normalCount" value="1" min="1" onchange="updateFloorOptions()" oninput="updateFloorOptions()">
                    <small style="color:#666; font-size:0.8em">Ka√ß adet normal kat var?</small>
                </div>
            </div>
        </div>

        <br>

        <div class="form-group">
            <label>Listeye Kat Ekle (Hesaplamaya Dahil Et):</label>
            <div style="display: flex; gap: 10px;">
                <select id="floorSelector">
                    </select>
                <button type="button" class="btn-secondary" onclick="addFloorRow()" style="width: auto; white-space: nowrap;">+ Ekle</button>
            </div>
        </div>

        <div id="floorsContainer">
            </div>

        <div id="calculationResult" class="result-box" style="display:none;"></div>

        <div style="margin-top: 20px;">
            <button type="button" class="btn-primary" onclick="saveRecord()">Kaydet ve Listeye Ekle</button>
            <button type="button" class="btn-secondary" onclick="clearForm()" style="margin-top: 10px; width: 100%; background-color: #ef4444;">Formu Temizle / ƒ∞ptal</button>
        </div>
    </div>

    <div class="card">
        <h3>Kaydedilen Analizler</h3>
        <div id="recordsList">
            <p style="color: #6b7280; text-align: center;">Hen√ºz kayƒ±tlƒ± analiz yok.</p>
        </div>
    </div>
</div>

<script>
    // Global deƒüi≈ükenler
    const TR_FORMAT = new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const TR_INT = new Intl.NumberFormat('tr-TR', { maximumFractionDigits: 0 });

    // Sayfa y√ºklendiƒüinde
    document.addEventListener('DOMContentLoaded', () => {
        updateFloorOptions(); // Ba≈ülangƒ±√ß se√ßeneklerini olu≈ütur
        loadRecords();
    });

    // Kat Se√ßeneklerini Dinamik G√ºncelleme Fonksiyonu
    function updateFloorOptions() {
        const basementCount = parseInt(document.getElementById('basementCount').value) || 0;
        const normalCount = parseInt(document.getElementById('normalCount').value) || 1;
        const selector = document.getElementById('floorSelector');
        
        // Listeyi temizle
        selector.innerHTML = '<option value="" disabled selected>Kat Se√ßiniz...</option>';

        // Bodrum Katlarƒ± Ekle (Ters sƒ±ralama daha mantƒ±klƒ±: 3. Bodrum -> 1. Bodrum)
        for (let i = basementCount; i >= 1; i--) {
            let val = `${i}.Bodrum Kat`;
            let option = document.createElement("option");
            option.value = val;
            option.text = val;
            selector.add(option);
        }

        // Sabit Katlar
        selector.add(new Option("Zemin Kat", "Zemin Kat"));
        selector.add(new Option("Asma Kat", "Asma Kat"));

        // Normal Katlarƒ± Ekle (1. Normal -> N. Normal)
        for (let i = 1; i <= normalCount; i++) {
            let val = `${i}.Normal Kat`;
            let option = document.createElement("option");
            option.value = val;
            option.text = val;
            selector.add(option);
        }

        // √áatƒ± Katƒ± (Sabit)
        selector.add(new Option("√áatƒ± Kat", "√áatƒ± Kat"));
    }

    // Listeye yeni kat satƒ±rƒ± ekleme
    function addFloorRow(floorName = null, area = '', ratio = '') {
        const selector = document.getElementById('floorSelector');
        const selectedFloor = floorName || selector.value;

        if (!selectedFloor) {
            alert("L√ºtfen √∂nce listeden bir kat se√ßiniz.");
            return;
        }

        const container = document.getElementById('floorsContainer');
        const rowId = Date.now() + Math.random(); 

        const div = document.createElement('div');
        div.className = 'floor-row';
        div.id = `row-${rowId}`;
        div.dataset.floorName = selectedFloor;

        div.innerHTML = `
            <div><strong>${selectedFloor}</strong></div>
            <div>
                <input type="number" class="floor-area" placeholder="Alan (m¬≤)" value="${area}">
            </div>
            <div>
                <input type="number" class="floor-ratio" placeholder="ƒ∞nd. Oranƒ±" value="${ratio}">
            </div>
            <div>
                <button type="button" class="btn-danger" onclick="removeFloorRow('${rowId}')">Sil</button>
            </div>
        `;

        container.appendChild(div);
        
        if(!floorName) selector.value = ""; // Manuel eklemede se√ßimi sƒ±fƒ±rla
    }

    function removeFloorRow(id) {
        document.getElementById(`row-${id}`).remove();
    }

    // Hesaplama (G√úNCELLENEN KISIM)
    function performCalculation() {
        const price = parseFloat(document.getElementById('askingPrice').value);
        // Deƒüi≈üiklik: Margin deƒüerini string olarak alƒ±yoruz (bo≈ü mu deƒüil mi kontrol√º i√ßin)
        const marginInput = document.getElementById('bargainMargin').value;
        const bCount = document.getElementById('basementCount').value;
        const nCount = document.getElementById('normalCount').value;
        
        if (isNaN(price)) {
            alert("L√ºtfen ƒ∞stenilen Fiyat bilgisini giriniz.");
            return null;
        }

        let roundedPrice;
        let margin = 0;
        
        // Pazarlƒ±k payƒ± girilmi≈üse (Bo≈ü deƒüilse ve sayƒ±ysa)
        if (marginInput !== '' && !isNaN(parseFloat(marginInput))) {
            margin = parseFloat(marginInput);
            let discountedPrice = price * (1 - (margin / 100));
            // Pazarlƒ±k payƒ± varsa yuvarlama yap
            roundedPrice = Math.round(discountedPrice / 100000) * 100000;
        } else {
            // Pazarlƒ±k payƒ± girilmediyse fiyatƒ± olduƒüu gibi kullan
            roundedPrice = price;
            margin = 0;
        }

        const rows = document.querySelectorAll('.floor-row');
        if (rows.length === 0) {
            alert("L√ºtfen en az bir kat ekleyiniz.");
            return null;
        }

        let totalReducedArea = 0;
        let floorDetails = [];

        for (let row of rows) {
            let name = row.dataset.floorName;
            let area = parseFloat(row.querySelector('.floor-area').value);
            let ratio = parseFloat(row.querySelector('.floor-ratio').value);

            if (isNaN(area) || isNaN(ratio) || ratio <= 0) {
                alert(`${name} i√ßin ge√ßerli alan ve indirgeme oranƒ± giriniz.`);
                return null;
            }

            let reducedArea = area / ratio;
            totalReducedArea += reducedArea;

            floorDetails.push({
                name: name,
                area: area,
                ratio: ratio,
                reduced: reducedArea
            });
        }

        let unitValue = 0;
        if (totalReducedArea > 0) {
            unitValue = roundedPrice / totalReducedArea;
        }

        return {
            price,
            margin,
            bCount,
            nCount,
            roundedPrice, // Bu artƒ±k ya yuvarlanmƒ±≈ü deƒüer ya da direkt fiyat
            floorDetails,
            totalReducedArea,
            unitValue,
            date: new Date().toLocaleString('tr-TR')
        };
    }

    // Kaydetme
    function saveRecord() {
        const result = performCalculation();
        if (!result) return;

        let records = JSON.parse(localStorage.getItem('katAnaliziRecordsV2')) || [];
        const editId = document.getElementById('editId').value;

        if (editId) {
            const index = records.findIndex(r => r.id == editId);
            if (index > -1) {
                result.id = Number(editId);
                records[index] = result;
            }
        } else {
            result.id = Date.now();
            records.unshift(result);
        }

        localStorage.setItem('katAnaliziRecordsV2', JSON.stringify(records));
        
        clearForm();
        loadRecords();
        alert("Kayƒ±t Ba≈üarƒ±yla ƒ∞≈ülendi!");
    }

    // Listeyi Y√ºkleme
    function loadRecords() {
        const records = JSON.parse(localStorage.getItem('katAnaliziRecordsV2')) || [];
        const container = document.getElementById('recordsList');
        
        if (records.length === 0) {
            container.innerHTML = '<p style="color: #6b7280; text-align: center;">Hen√ºz kayƒ±tlƒ± analiz yok.</p>';
            return;
        }

        let html = '';
        records.forEach(rec => {
            // Eƒüer margin 0 ise listede "Pazarlƒ±k Yok" veya 0% g√∂sterebiliriz, ≈üu an %0 g√∂r√ºnecek
            html += `
                <div class="card record-item">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <h4 style="margin:0;">${rec.date}</h4>
                        <span style="background:#dbeafe; color:#1e40af; padding:2px 8px; border-radius:4px; font-size:0.9rem; font-weight:bold;">
                            ${TR_FORMAT.format(rec.unitValue)} TL/m¬≤
                        </span>
                    </div>
                    
                    <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.9rem;">
                        <div>
                            <strong>ƒ∞stenen:</strong> ${TR_INT.format(rec.price)} TL<br>
                            <strong>Pazarlƒ±k:</strong> %${rec.margin}<br>
                            <strong>Hesaplanan:</strong> ${TR_INT.format(rec.roundedPrice)} TL
                        </div>
                        <div>
                            <strong>Bina Yapƒ±sƒ±:</strong> ${rec.bCount} Bodrum, ${rec.nCount} Normal<br>
                            <strong>Top. ƒ∞nd. Alan:</strong> ${TR_FORMAT.format(rec.totalReducedArea)} m¬≤
                        </div>
                    </div>

                    <div style="margin-top:10px; background:#fff; padding:5px; border:1px dashed #ccc; font-size:0.85rem;">
                        <strong>Detaylar:</strong><br>
                        ${rec.floorDetails.map(f => `${f.name}: ${f.area}m¬≤ / ${f.ratio} = ${TR_FORMAT.format(f.reduced)}`).join('<br>')}
                    </div>

                    <div class="record-actions">
                        <button class="btn-edit" onclick="editRecord(${rec.id})">D√ºzenle</button>
                        <button class="btn-danger" onclick="deleteRecord(${rec.id})">Sil</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // D√ºzenleme
    function editRecord(id) {
        const records = JSON.parse(localStorage.getItem('katAnaliziRecordsV2')) || [];
        const rec = records.find(r => r.id === id);
        if (!rec) return;

        // Formu doldur
        document.getElementById('editId').value = rec.id;
        document.getElementById('askingPrice').value = rec.price;
        // Eƒüer margin 0 ise bo≈ü bƒ±rak, deƒüilse yaz (Kullanƒ±cƒ± 0 girmi≈üse 0 yazar, bo≈üsa bo≈ü kalƒ±r)
        document.getElementById('bargainMargin').value = rec.margin === 0 ? '' : rec.margin;
        
        // Kat sayƒ±larƒ±nƒ± geri y√ºkle
        document.getElementById('basementCount').value = rec.bCount || 1;
        document.getElementById('normalCount').value = rec.nCount || 1;
        
        // Dropdown'ƒ± bu sayƒ±lara g√∂re g√ºncelle
        updateFloorOptions();

        // Eklenmi≈ü kat satƒ±rlarƒ±nƒ± geri y√ºkle
        document.getElementById('floorsContainer').innerHTML = '';
        rec.floorDetails.forEach(f => {
            addFloorRow(f.name, f.area, f.ratio);
        });

        document.getElementById('inputForm').scrollIntoView({ behavior: 'smooth' });
    }

    function deleteRecord(id) {
        if (!confirm("Bu kaydƒ± silmek istediƒüinize emin misiniz?")) return;
        let records = JSON.parse(localStorage.getItem('katAnaliziRecordsV2')) || [];
        records = records.filter(r => r.id !== id);
        localStorage.setItem('katAnaliziRecordsV2', JSON.stringify(records));
        loadRecords();
    }

    function clearForm() {
        document.getElementById('editId').value = '';
        document.getElementById('askingPrice').value = '';
        document.getElementById('bargainMargin').value = '';
        
        // Varsayƒ±lanlara d√∂n
        document.getElementById('basementCount').value = '1';
        document.getElementById('normalCount').value = '1';
        updateFloorOptions(); // Dropdown'ƒ± resetle

        document.getElementById('floorSelector').value = '';
        document.getElementById('floorsContainer').innerHTML = '';
        document.getElementById('calculationResult').style.display = 'none';
    }

</script>

</body>
</html>
