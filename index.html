<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kat Analizi ve ƒ∞ndirgeme Programƒ± v2.6</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --danger: #dc2626;
            --success: #16a34a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1, h2, h3 {
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input:focus {
            outline: 2px solid var(--primary);
            border-color: transparent;
        }

        .row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .col {
            flex: 1;
            min-width: 200px;
        }

        button {
            cursor: pointer;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            width: 100%;
            font-size: 1.1rem;
        }
        .btn-secondary {
            background-color: #64748b;
            color: white;
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .btn-edit {
            background-color: var(--primary);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            margin-right: 5px;
        }
        .btn-warning {
            background-color: #ef4444;
            color: white;
        }

        .floor-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            background: #f8fafc;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }

        @media (max-width: 600px) {
            .floor-row { grid-template-columns: 1fr; }
            .btn-danger { width: 100%; margin-top: 5px; }
        }

        .result-box {
            background-color: #ecfdf5;
            border: 1px solid #10b981;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .instant-result {
            margin-top: 10px;
            padding: 10px;
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            border-radius: 6px;
            font-weight: bold;
            display: none;
        }

        .record-item {
            border-left: 4px solid var(--primary);
            padding-left: 15px;
            margin-bottom: 15px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            position: relative;
        }

        .record-actions {
            margin-top: 10px;
            text-align: right;
        }

        .divider {
            border: 0;
            border-top: 1px solid #e5e7eb;
            margin: 20px 0;
        }

        /* √úst sekmeler */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tab-btn {
            flex: 1;
            background: #e5e7eb;
            color: #111827;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            padding: 12px 10px;
            font-weight: 800;
        }
        .tab-btn.active {
            background: #dbeafe;
            color: #1e40af;
            border-color: #bfdbfe;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Dubleks alt sekmeler */
        .subtabs {
            display:flex;
            gap:10px;
            flex-wrap:wrap;
            margin-bottom: 10px;
        }
        .subtab-btn {
            flex:1;
            background:#f3f4f6;
            border:1px solid #e5e7eb;
            border-radius:10px;
            padding:10px;
            font-weight:900;
            color:#111827;
        }
        .subtab-btn.active {
            background:#dbeafe;
            border-color:#bfdbfe;
            color:#1e40af;
        }
        .subtab-panel { display:none; }
        .subtab-panel.active { display:block; }

        /* Dubleks √∂zet */
        .dubleks-summary {
            background: #fff;
            border: 1px solid #e5e7eb;
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
        }
        .mini { font-size: 0.9rem; color: #374151; }
        .pill {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 800;
            font-size: 0.85rem;
        }
        .grid3 {
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap:10px;
        }
        @media (max-width:600px){
            .grid3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üèóÔ∏è Kat Analizi Programƒ±</h1>

    <!-- √úST SEKME BUTONLARI -->
    <div class="tabs card" style="padding:12px;">
        <button type="button" class="tab-btn active" id="tabKatAnaliziBtn">Kat Analizi</button>
        <button type="button" class="tab-btn" id="tabDubleksBtn">Dubleks Analiz</button>
    </div>

    <!-- 1) KAT ANALƒ∞Zƒ∞ PANELƒ∞ -->
    <div class="tab-panel active" id="panelKatAnalizi">

        <section class="card" id="inputForm">
            <h3>Yeni Analiz Olu≈ütur</h3>

            <div id="messageBox" class="instant-result" aria-live="polite" style="display:none;"></div>

            <form id="analysisForm">
                <input type="hidden" id="editId">

                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="askingPrice">ƒ∞stenilen Fiyat (TL)</label>
                            <input type="number" id="askingPrice" placeholder="√ñrn: 10000000"
                                   inputmode="numeric" pattern="[0-9]*" step="1" min="0">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="bargainMargin">Pazarlƒ±k Payƒ± (%) - Opsiyonel</label>
                            <input type="number" id="bargainMargin" placeholder="Bo≈ü bƒ±rakƒ±lƒ±rsa fiyat baz alƒ±nƒ±r"
                                   inputmode="decimal" step="0.01" min="0">
                        </div>
                    </div>
                </div>

                <div id="instantPriceDisplay" class="instant-result"></div>

                <hr class="divider">

                <h4 style="color: var(--text);">Bina Kat Yapƒ±landƒ±rmasƒ±</h4>
                <div class="row" style="background: #eff6ff; padding: 15px; border-radius: 8px; border: 1px solid #bfdbfe;">
                    <div class="col">
                        <div class="form-group">
                            <label for="basementCount">Bodrum Kat Sayƒ±sƒ±</label>
                            <input type="number" id="basementCount" value="1" min="0"
                                   inputmode="numeric" pattern="[0-9]*" step="1">
                            <small style="color:#666; font-size:0.8em">Ka√ß adet bodrum kat var?</small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="normalCount">Normal Kat Sayƒ±sƒ±</label>
                            <input type="number" id="normalCount" value="1" min="1"
                                   inputmode="numeric" pattern="[0-9]*" step="1">
                            <small style="color:#666; font-size:0.8em">Ka√ß adet normal kat var?</small>
                        </div>
                    </div>
                </div>

                <br>

                <div class="form-group">
                    <label for="floorSelector">Listeye Kat Ekle (Hesaplamaya Dahil Et):</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="floorSelector"></select>
                        <button type="button" id="addFloorBtn" class="btn-secondary" style="width: auto; white-space: nowrap;">+ Ekle</button>
                    </div>
                </div>

                <div id="floorsContainer"></div>

                <!-- ‚úÖ Kat Analizi: CANLI HESAP (YENƒ∞) -->
                <div id="katLiveCalc" class="result-box" style="display:block;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
                        <div>
                            <strong>Canlƒ± Hesap</strong>
                            <div style="font-size:0.9rem; color:#065f46; margin-top:4px;">
                                Alan/Oran ve Fiyat girdik√ße otomatik g√ºncellenir.
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.85rem; color:#065f46;">Birim Deƒüer</div>
                            <div style="font-size:1.1rem; font-weight:900;" id="katLiveUnitValue">0 TL/m¬≤</div>
                        </div>
                    </div>

                    <hr class="divider" style="margin:12px 0;">

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.95rem;">
                        <div>
                            <strong>Hesaplanan (Yuvarlanmƒ±≈ü):</strong><br>
                            <span id="katLiveRoundedPrice">0 TL</span>
                        </div>
                        <div>
                            <strong>Toplam ƒ∞ndirgenmi≈ü Alan:</strong><br>
                            <span id="katLiveTotalReducedArea">0 m¬≤</span>
                        </div>
                    </div>
                </div>

                <div id="calculationResult" class="result-box" style="display:none;"></div>

                <div style="margin-top: 20px;">
                    <button type="submit" class="btn-primary">Kaydet ve Listeye Ekle</button>
                    <button type="button" id="clearFormBtn" class="btn-secondary btn-warning" style="margin-top: 10px; width: 100%;">Formu Temizle / ƒ∞ptal</button>
                </div>
            </form>
        </section>

        <section class="card">
            <h3>Kaydedilen Analizler</h3>
            <div id="recordsList" aria-live="polite">
                <p style="color: #6b7280; text-align: center;">Hen√ºz kayƒ±tlƒ± analiz yok.</p>
            </div>
        </section>

    </div>

    <!-- 2) DUBLEKS ANALƒ∞Z PANELƒ∞ -->
    <div class="tab-panel" id="panelDubleks">

        <section class="card" id="dubleksFormCard">
            <h3>Dubleks Analiz</h3>

            <div id="dubleksMessageBox" class="instant-result" aria-live="polite" style="display:none;"></div>

            <div class="subtabs">
                <button type="button" class="subtab-btn active" id="subtabYasalBtn">Yasal Alan</button>
                <button type="button" class="subtab-btn" id="subtabMevcutBtn">Mevcut Alan</button>
            </div>

            <form id="dubleksForm">
                <input type="hidden" id="dubleksEditId">

                <div class="subtab-panel active" id="panelYasal">
                    <div class="card" style="background:#f8fafc; border:1px solid #e5e7eb;">
                        <h4 style="margin-top:0;">Yasal Alan</h4>

                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="yasalNormalArea">Normal Kat - Alan (m¬≤)</label>
                                    <input type="number" id="yasalNormalArea" placeholder="√ñrn: 80"
                                           inputmode="decimal" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="yasalUnitValue">Birim Deƒüer (TL/m¬≤)</label>
                                    <input type="number" id="yasalUnitValue" placeholder="√ñrn: 50000"
                                           inputmode="numeric" pattern="[0-9]*" step="1" min="0">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="yasalRoofArea">√áatƒ± Kat - Alan (m¬≤)</label>
                                    <input type="number" id="yasalRoofArea" placeholder="√ñrn: 20"
                                           inputmode="decimal" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="yasalRoofRatio">√áatƒ± Kat - Oran (%)</label>
                                    <input type="number" id="yasalRoofRatio" placeholder="√ñrn: 60"
                                           inputmode="decimal" step="0.01" min="0" max="100">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="yasalTerasArea">Teras - Alan (m¬≤)</label>
                                    <input type="number" id="yasalTerasArea" placeholder="√ñrn: 15"
                                           inputmode="decimal" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="yasalTerasRatio">Teras - Oran (%)</label>
                                    <input type="number" id="yasalTerasRatio" placeholder="√ñrn: 50"
                                           inputmode="decimal" step="0.01" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="subtab-panel" id="panelMevcut">
                    <div class="card" style="background:#f8fafc; border:1px solid #e5e7eb;">
                        <h4 style="margin-top:0;">Mevcut Alan</h4>

                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="mevcutNormalArea">Normal Kat - Alan (m¬≤)</label>
                                    <input type="number" id="mevcutNormalArea" placeholder="√ñrn: 85"
                                           inputmode="decimal" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="mevcutUnitValue">Birim Deƒüer (TL/m¬≤)</label>
                                    <input type="number" id="mevcutUnitValue" placeholder="√ñrn: 50000"
                                           inputmode="numeric" pattern="[0-9]*" step="1" min="0">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="mevcutRoofArea">√áatƒ± Kat - Alan (m¬≤)</label>
                                    <input type="number" id="mevcutRoofArea" placeholder="√ñrn: 25"
                                           inputmode="decimal" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="mevcutRoofRatio">√áatƒ± Kat - Oran (%)</label>
                                    <input type="number" id="mevcutRoofRatio" placeholder="√ñrn: 60"
                                           inputmode="decimal" step="0.01" min="0" max="100">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="mevcutTerasArea">Teras - Alan (m¬≤)</label>
                                    <input type="number" id="mevcutTerasArea" placeholder="√ñrn: 18"
                                           inputmode="decimal" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="mevcutTerasRatio">Teras - Oran (%)</label>
                                    <input type="number" id="mevcutTerasRatio" placeholder="√ñrn: 50"
                                           inputmode="decimal" step="0.01" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dubleks-summary" id="dubleksLiveSummary">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                        <div>
                            <span class="pill">Canlƒ± Hesaplama √ñzeti</span>
                            <div class="mini" style="margin-top:6px;">Yasal ve Mevcut alanlar otomatik hesaplanƒ±r.</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="mini">Genel Toplam (Yasal + Mevcut)</div>
                            <div style="font-size:1.2rem; font-weight:900; color:#111827;" id="dubleksGrandTotalText">0 TL</div>
                        </div>
                    </div>

                    <hr class="divider" style="margin:12px 0;">

                    <div class="grid3">
                        <div style="border:1px dashed #d1d5db; border-radius:10px; padding:10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>Yasal Toplam</strong>
                                <span class="pill" id="yasalTotalText">0 TL</span>
                            </div>

                            <!-- ‚úÖ Dubleks: CANLI TOPLAM ALAN (YENƒ∞) -->
                            <div class="mini" style="margin-top:8px;">
                                <strong>Toplam Alan (Normal + √áatƒ±):</strong> <span id="yasalTotalAreaText">0 m¬≤</span>
                            </div>

                            <div class="mini" style="margin-top:10px;">
                                Normal: <strong id="yasalNormalCalcText">0 TL</strong><br>
                                √áatƒ±: <strong id="yasalRoofCalcText">0 TL</strong><br>
                                Teras: <strong id="yasalTerasCalcText">0 TL</strong>
                            </div>
                        </div>

                        <div style="border:1px dashed #d1d5db; border-radius:10px; padding:10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>Mevcut Toplam</strong>
                                <span class="pill" id="mevcutTotalText">0 TL</span>
                            </div>

                            <!-- ‚úÖ Dubleks: CANLI TOPLAM ALAN (YENƒ∞) -->
                            <div class="mini" style="margin-top:8px;">
                                <strong>Toplam Alan (Normal + √áatƒ±):</strong> <span id="mevcutTotalAreaText">0 m¬≤</span>
                            </div>

                            <div class="mini" style="margin-top:10px;">
                                Normal: <strong id="mevcutNormalCalcText">0 TL</strong><br>
                                √áatƒ±: <strong id="mevcutRoofCalcText">0 TL</strong><br>
                                Teras: <strong id="mevcutTerasCalcText">0 TL</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <button type="submit" class="btn-primary">Kaydet ve Listeye Ekle</button>
                    <button type="button" id="dubleksClearBtn" class="btn-secondary btn-warning" style="margin-top: 10px; width: 100%;">Temizle / ƒ∞ptal</button>
                </div>
            </form>
        </section>

        <section class="card">
            <h3>Kaydedilen Dubleks Analizler</h3>
            <div id="dubleksRecordsList" aria-live="polite">
                <p style="color: #6b7280; text-align: center;">Hen√ºz kayƒ±tlƒ± analiz yok.</p>
            </div>
        </section>

    </div>

</div>

<script>
    // Global sabitler
    const TR_FORMAT = new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const TR_INT = new Intl.NumberFormat('tr-TR', { maximumFractionDigits: 0 });
    const STORAGE_KEY = 'katAnaliziRecordsV2';

    // Dubleks storage
    const DUBLEKS_STORAGE_KEY = 'dubleksAnalizRecordsV1';

    // Ortak fiyat yuvarlama fonksiyonu
    function getRoundedPrice(price, marginInput) {
        let roundedPrice = price;
        let margin = 0;

        if (marginInput !== '' && !isNaN(parseFloat(marginInput))) {
            margin = parseFloat(marginInput);
            const discountedPrice = price * (1 - (margin / 100));
            roundedPrice = Math.round(discountedPrice / 100000) * 100000;
        }

        return { roundedPrice, margin };
    }

    // Mesaj g√∂sterme fonksiyonu (alert yerine)
    function showMessage(message, type = 'info') {
        const box = document.getElementById('messageBox');
        box.textContent = message;
        box.style.display = 'block';

        if (type === 'error') {
            box.style.backgroundColor = '#fee2e2';
            box.style.borderColor = '#fecaca';
            box.style.color = '#b91c1c';
        } else if (type === 'success') {
            box.style.backgroundColor = '#ecfdf5';
            box.style.borderColor = '#bbf7d0';
            box.style.color = '#166534';
        } else {
            box.style.backgroundColor = '#eff6ff';
            box.style.borderColor = '#bfdbfe';
            box.style.color = '#1e40af';
        }
    }
    function hideMessage() {
        const box = document.getElementById('messageBox');
        box.style.display = 'none';
    }

    // Dubleks mesaj kutusu
    function showDubleksMessage(message, type = 'info') {
        const box = document.getElementById('dubleksMessageBox');
        box.textContent = message;
        box.style.display = 'block';

        if (type === 'error') {
            box.style.backgroundColor = '#fee2e2';
            box.style.borderColor = '#fecaca';
            box.style.color = '#b91c1c';
        } else if (type === 'success') {
            box.style.backgroundColor = '#ecfdf5';
            box.style.borderColor = '#bbf7d0';
            box.style.color = '#166534';
        } else {
            box.style.backgroundColor = '#eff6ff';
            box.style.borderColor = '#bfdbfe';
            box.style.color = '#1e40af';
        }
    }
    function hideDubleksMessage() {
        const box = document.getElementById('dubleksMessageBox');
        box.style.display = 'none';
    }

    // Anlƒ±k Fiyat Hesaplama
    function calculateInstantPrice() {
        const price = parseFloat(document.getElementById('askingPrice').value);
        const marginInput = document.getElementById('bargainMargin').value;
        const displayDiv = document.getElementById('instantPriceDisplay');

        if (isNaN(price)) {
            displayDiv.style.display = 'none';
            return;
        }

        const { roundedPrice } = getRoundedPrice(price, marginInput);

        displayDiv.innerHTML = `Hesaplanan Deƒüer (Yuvarlanmƒ±≈ü): ${TR_INT.format(roundedPrice)} TL`;
        displayDiv.style.display = 'block';
    }

    // ‚úÖ Kat Analizi: CANLI HESAP (YENƒ∞)
    function katRecalcLive() {
        const price = parseFloat(document.getElementById('askingPrice').value);
        const marginInput = document.getElementById('bargainMargin').value;

        let roundedPrice = 0;
        if (!isNaN(price)) {
            roundedPrice = getRoundedPrice(price, marginInput).roundedPrice;
        }

        const rows = document.querySelectorAll('.floor-row');
        let totalReducedArea = 0;

        // Eksik satƒ±rlarƒ± kƒ±rmadan (0 sayarak) canlƒ± hesap
        for (const row of rows) {
            const area = parseFloat(row.querySelector('.floor-area')?.value);
            const ratio = parseFloat(row.querySelector('.floor-ratio')?.value);
            if (!isNaN(area) && !isNaN(ratio) && ratio > 0) {
                totalReducedArea += (area / ratio);
            }
        }

        const unitValue = (roundedPrice > 0 && totalReducedArea > 0) ? (roundedPrice / totalReducedArea) : 0;

        document.getElementById('katLiveRoundedPrice').textContent = `${TR_INT.format(roundedPrice)} TL`;
        document.getElementById('katLiveTotalReducedArea').textContent = `${TR_FORMAT.format(totalReducedArea)} m¬≤`;
        document.getElementById('katLiveUnitValue').textContent = `${TR_FORMAT.format(unitValue)} TL/m¬≤`;
    }

    // Kat Se√ßeneklerini Dinamik G√ºncelleme
    function updateFloorOptions() {
        const basementCount = parseInt(document.getElementById('basementCount').value) || 0;
        const normalCount = parseInt(document.getElementById('normalCount').value) || 1;
        const selector = document.getElementById('floorSelector');

        selector.innerHTML = '<option value="" disabled selected>Kat Se√ßiniz...</option>';

        for (let i = basementCount; i >= 1; i--) {
            const val = `${i}.Bodrum Kat`;
            const option = document.createElement('option');
            option.value = val;
            option.text = val;
            selector.add(option);
        }

        selector.add(new Option("Zemin Kat", "Zemin Kat"));
        selector.add(new Option("Asma Kat", "Asma Kat"));

        for (let i = 1; i <= normalCount; i++) {
            const val = `${i}.Normal Kat`;
            const option = document.createElement('option');
            option.value = val;
            option.text = val;
            selector.add(option);
        }

        selector.add(new Option("√áatƒ± Kat", "√áatƒ± Kat"));
    }

    // Listeye yeni kat satƒ±rƒ± ekleme
    function addFloorRow(floorName = null, area = '', ratio = '') {
        const selector = document.getElementById('floorSelector');
        const selectedFloor = floorName || selector.value;

        if (!selectedFloor) {
            showMessage("L√ºtfen √∂nce listeden bir kat se√ßiniz.", 'error');
            return;
        }

        const container = document.getElementById('floorsContainer');
        const rowId = Date.now() + Math.random();

        const div = document.createElement('div');
        div.className = 'floor-row';
        div.id = `row-${rowId}`;
        div.dataset.floorName = selectedFloor;

        div.innerHTML = `
            <div><strong>${selectedFloor}</strong></div>
            <div>
                <input type="number" class="floor-area" placeholder="Alan (m¬≤)" value="${area}"
                       inputmode="decimal" step="0.01" min="0">
            </div>
            <div>
                <input type="number" class="floor-ratio" placeholder="ƒ∞nd. Oranƒ±" value="${ratio}"
                       inputmode="decimal" step="0.01" min="0">
            </div>
            <div>
                <button type="button" class="btn-danger" onclick="removeFloorRow('${rowId}')">Sil</button>
            </div>
        `;

        container.appendChild(div);
        if (!floorName) selector.value = "";

        // ‚úÖ canlƒ± g√ºncelle
        katRecalcLive();
    }

    function removeFloorRow(id) {
        const row = document.getElementById(`row-${id}`);
        if (row) row.remove();

        // ‚úÖ canlƒ± g√ºncelle
        katRecalcLive();
    }

    // Hesaplama (Kaydet butonu i√ßin)
    function performCalculation() {
        hideMessage();

        const price = parseFloat(document.getElementById('askingPrice').value);
        const marginInput = document.getElementById('bargainMargin').value;
        const bCount = document.getElementById('basementCount').value;
        const nCount = document.getElementById('normalCount').value;

        if (isNaN(price)) {
            showMessage("L√ºtfen ƒ∞stenilen Fiyat bilgisini giriniz.", 'error');
            return null;
        }

        const { roundedPrice, margin } = getRoundedPrice(price, marginInput);

        const rows = document.querySelectorAll('.floor-row');
        if (rows.length === 0) {
            showMessage("L√ºtfen en az bir kat ekleyiniz.", 'error');
            return null;
        }

        let totalReducedArea = 0;
        const floorDetails = [];

        for (const row of rows) {
            const name = row.dataset.floorName;
            const area = parseFloat(row.querySelector('.floor-area').value);
            const ratio = parseFloat(row.querySelector('.floor-ratio').value);

            if (isNaN(area) || isNaN(ratio) || ratio <= 0) {
                showMessage(`${name} i√ßin ge√ßerli alan ve indirgeme oranƒ± giriniz.`, 'error');
                return null;
            }

            const reducedArea = area / ratio;
            totalReducedArea += reducedArea;

            floorDetails.push({
                name: name,
                area: area,
                ratio: ratio,
                reduced: reducedArea
            });
        }

        let unitValue = 0;
        if (totalReducedArea > 0) unitValue = roundedPrice / totalReducedArea;

        return {
            price,
            margin,
            bCount,
            nCount,
            roundedPrice,
            floorDetails,
            totalReducedArea,
            unitValue,
            date: new Date().toLocaleString('tr-TR')
        };
    }

    // Kaydetme
    function saveRecord() {
        const result = performCalculation();
        if (!result) return;

        let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const editId = document.getElementById('editId').value;

        if (editId) {
            const index = records.findIndex(r => r.id == editId);
            if (index > -1) {
                result.id = Number(editId);
                records[index] = result;
            }
        } else {
            result.id = Date.now();
            records.unshift(result);
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));

        clearForm();
        loadRecords();
        showMessage("Kayƒ±t ba≈üarƒ±yla i≈ülendi!", 'success');
    }

    // Listeyi Y√ºkleme
    function loadRecords() {
        const records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const container = document.getElementById('recordsList');

        if (records.length === 0) {
            container.innerHTML = '<p style="color: #6b7280; text-align: center;">Hen√ºz kayƒ±tlƒ± analiz yok.</p>';
            return;
        }

        let html = '';
        records.forEach(rec => {
            html += `
                <div class="card record-item">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <h4 style="margin:0;">${rec.date}</h4>
                        <span style="background:#dbeafe; color:#1e40af; padding:2px 8px; border-radius:4px; font-size:0.9rem; font-weight:bold;">
                            ${TR_FORMAT.format(rec.unitValue)} TL/m¬≤
                        </span>
                    </div>

                    <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.9rem;">
                        <div>
                            <strong>ƒ∞stenen:</strong> ${TR_INT.format(rec.price)} TL<br>
                            <strong>Pazarlƒ±k:</strong> %${rec.margin}<br>
                            <strong>Hesaplanan:</strong> ${TR_INT.format(rec.roundedPrice)} TL
                        </div>
                        <div>
                            <strong>Bina Yapƒ±sƒ±:</strong> ${rec.bCount} Bodrum, ${rec.nCount} Normal<br>
                            <strong>Top. ƒ∞nd. Alan:</strong> ${TR_FORMAT.format(rec.totalReducedArea)} m¬≤
                        </div>
                    </div>

                    <div style="margin-top:10px; background:#fff; padding:5px; border:1px dashed #ccc; font-size:0.85rem;">
                        <strong>Detaylar:</strong><br>
                        ${rec.floorDetails.map(f => `${f.name}: ${f.area}m¬≤ / ${f.ratio} = ${TR_FORMAT.format(f.reduced)}`).join('<br>')}
                    </div>

                    <div class="record-actions">
                        <button class="btn-edit" onclick="editRecord(${rec.id})">D√ºzenle</button>
                        <button class="btn-danger" onclick="deleteRecord(${rec.id})">Sil</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // D√ºzenleme
    function editRecord(id) {
        hideMessage();

        const records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const rec = records.find(r => r.id === id);
        if (!rec) return;

        document.getElementById('editId').value = rec.id;
        document.getElementById('askingPrice').value = rec.price;
        document.getElementById('bargainMargin').value = rec.margin === 0 ? '' : rec.margin;

        calculateInstantPrice();

        document.getElementById('basementCount').value = rec.bCount || 1;
        document.getElementById('normalCount').value = rec.nCount || 1;

        updateFloorOptions();

        document.getElementById('floorsContainer').innerHTML = '';
        rec.floorDetails.forEach(f => addFloorRow(f.name, f.area, f.ratio));

        const title = document.querySelector('#inputForm h3');
        if (title) title.textContent = 'Analiz D√ºzenle';

        document.getElementById('inputForm').scrollIntoView({ behavior: 'smooth' });

        // ‚úÖ canlƒ± g√ºncelle
        katRecalcLive();
    }

    function deleteRecord(id) {
        hideMessage();
        if (!confirm("Bu kaydƒ± silmek istediƒüinize emin misiniz?")) return;
        let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        records = records.filter(r => r.id !== id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        loadRecords();
        showMessage("Kayƒ±t silindi.", 'success');
    }

    function clearForm() {
        hideMessage();

        document.getElementById('editId').value = '';
        document.getElementById('askingPrice').value = '';
        document.getElementById('bargainMargin').value = '';
        document.getElementById('instantPriceDisplay').style.display = 'none';

        document.getElementById('basementCount').value = '1';
        document.getElementById('normalCount').value = '1';
        updateFloorOptions();

        document.getElementById('floorSelector').value = '';
        document.getElementById('floorsContainer').innerHTML = '';
        document.getElementById('calculationResult').style.display = 'none';

        const title = document.querySelector('#inputForm h3');
        if (title) title.textContent = 'Yeni Analiz Olu≈ütur';

        // ‚úÖ canlƒ± g√ºncelle
        katRecalcLive();
    }

    // -----------------------------
    // DUBLEKS ANALƒ∞Z
    // -----------------------------
    function numOrZero(v) {
        const n = parseFloat(v);
        return isNaN(n) ? 0 : n;
    }

    function getDubleksInputs() {
        return {
            yasal: {
                normalArea: numOrZero(document.getElementById('yasalNormalArea').value),
                unitValue:  numOrZero(document.getElementById('yasalUnitValue').value),
                roofArea:   numOrZero(document.getElementById('yasalRoofArea').value),
                roofRatio:  numOrZero(document.getElementById('yasalRoofRatio').value),
                terasArea:  numOrZero(document.getElementById('yasalTerasArea').value),
                terasRatio: numOrZero(document.getElementById('yasalTerasRatio').value),
            },
            mevcut: {
                normalArea: numOrZero(document.getElementById('mevcutNormalArea').value),
                unitValue:  numOrZero(document.getElementById('mevcutUnitValue').value),
                roofArea:   numOrZero(document.getElementById('mevcutRoofArea').value),
                roofRatio:  numOrZero(document.getElementById('mevcutRoofRatio').value),
                terasArea:  numOrZero(document.getElementById('mevcutTerasArea').value),
                terasRatio: numOrZero(document.getElementById('mevcutTerasRatio').value),
            }
        };
    }

    function calcSection(sec) {
        const normalCalc = sec.normalArea * sec.unitValue;

        const roofEffUnit  = sec.unitValue * (sec.roofRatio / 100);
        const roofCalc     = sec.roofArea * roofEffUnit;

        const terasEffUnit = sec.unitValue * (sec.terasRatio / 100);
        const terasCalc    = sec.terasArea * terasEffUnit;

        const total = normalCalc + roofCalc + terasCalc;

        return { normalCalc, roofCalc, terasCalc, total };
    }

    function dubleksRecalcLive() {
        const { yasal, mevcut } = getDubleksInputs();

        const y = calcSection(yasal);
        const m = calcSection(mevcut);

        document.getElementById('yasalNormalCalcText').textContent = `${TR_INT.format(y.normalCalc)} TL`;
        document.getElementById('yasalRoofCalcText').textContent   = `${TR_INT.format(y.roofCalc)} TL`;
        document.getElementById('yasalTerasCalcText').textContent  = `${TR_INT.format(y.terasCalc)} TL`;
        document.getElementById('yasalTotalText').textContent      = `${TR_INT.format(y.total)} TL`;

        document.getElementById('mevcutNormalCalcText').textContent = `${TR_INT.format(m.normalCalc)} TL`;
        document.getElementById('mevcutRoofCalcText').textContent   = `${TR_INT.format(m.roofCalc)} TL`;
        document.getElementById('mevcutTerasCalcText').textContent  = `${TR_INT.format(m.terasCalc)} TL`;
        document.getElementById('mevcutTotalText').textContent      = `${TR_INT.format(m.total)} TL`;

        const grand = y.total + m.total;
        document.getElementById('dubleksGrandTotalText').textContent = `${TR_INT.format(grand)} TL`;

        // ‚úÖ ƒ∞stenen: Toplam Alan = Normal + √áatƒ± (Canlƒ±)
        const yArea = yasal.normalArea + yasal.roofArea;
        const mArea = mevcut.normalArea + mevcut.roofArea;
        document.getElementById('yasalTotalAreaText').textContent = `${TR_FORMAT.format(yArea)} m¬≤`;
        document.getElementById('mevcutTotalAreaText').textContent = `${TR_FORMAT.format(mArea)} m¬≤`;
    }

    // -----------------------------
    // Dubleks kayƒ±t/okuma fonksiyonlarƒ± (DEƒûƒ∞≈ûMEDƒ∞)
    // -----------------------------
    function normalizeDubleksRecord(rec) {
        if (rec && rec.yasal && rec.mevcut) {
            rec.yasal.terasArea = rec.yasal.terasArea ?? 0;
            rec.yasal.terasRatio = rec.yasal.terasRatio ?? 0;
            rec.mevcut.terasArea = rec.mevcut.terasArea ?? 0;
            rec.mevcut.terasRatio = rec.mevcut.terasRatio ?? 0;
            return rec;
        }

        const yasal = {
            normalArea: rec.normalArea ?? 0,
            unitValue:  rec.unitValue ?? 0,
            roofArea:   rec.roofArea ?? 0,
            roofRatio:  rec.roofRatio ?? 0,
            terasArea:  0,
            terasRatio: 0
        };
        const mevcut = {
            normalArea: 0,
            unitValue:  0,
            roofArea:   0,
            roofRatio:  0,
            terasArea:  0,
            terasRatio: 0
        };

        const y = calcSection(yasal);
        const m = calcSection(mevcut);

        return {
            ...rec,
            yasal,
            mevcut,
            yasalCalc: y,
            mevcutCalc: m,
            grandTotal: y.total + m.total
        };
    }

    function dubleksPerform() {
        hideDubleksMessage();

        const anyFilled =
            document.getElementById('yasalNormalArea').value !== '' ||
            document.getElementById('yasalUnitValue').value !== '' ||
            document.getElementById('yasalRoofArea').value !== '' ||
            document.getElementById('yasalRoofRatio').value !== '' ||
            document.getElementById('yasalTerasArea').value !== '' ||
            document.getElementById('yasalTerasRatio').value !== '' ||
            document.getElementById('mevcutNormalArea').value !== '' ||
            document.getElementById('mevcutUnitValue').value !== '' ||
            document.getElementById('mevcutRoofArea').value !== '' ||
            document.getElementById('mevcutRoofRatio').value !== '' ||
            document.getElementById('mevcutTerasArea').value !== '' ||
            document.getElementById('mevcutTerasRatio').value !== '';

        if (!anyFilled) {
            showDubleksMessage("L√ºtfen en az bir alan giriniz.", "error");
            return null;
        }

        const { yasal, mevcut } = getDubleksInputs();

        if (yasal.unitValue <= 0 && mevcut.unitValue <= 0) {
            showDubleksMessage("L√ºtfen en az bir tarafta 'Birim Deƒüer' giriniz (Yasal veya Mevcut).", "error");
            return null;
        }

        const yCalc = calcSection(yasal);
        const mCalc = calcSection(mevcut);

        const result = {
            yasal,
            mevcut,
            yasalCalc: yCalc,
            mevcutCalc: mCalc,
            grandTotal: yCalc.total + mCalc.total,
            date: new Date().toLocaleString('tr-TR'),

            normalArea: yasal.normalArea,
            unitValue: yasal.unitValue,
            roofArea: yasal.roofArea,
            roofRatio: yasal.roofRatio,
            normalCalc: yCalc.normalCalc,
            roofCalc: yCalc.roofCalc,
            total: yCalc.total
        };

        return result;
    }

    function dubleksSave() {
        const result = dubleksPerform();
        if (!result) return;

        let records = JSON.parse(localStorage.getItem(DUBLEKS_STORAGE_KEY)) || [];
        const editId = document.getElementById('dubleksEditId').value;

        if (editId) {
            const idx = records.findIndex(r => r.id == editId);
            if (idx > -1) {
                result.id = Number(editId);
                records[idx] = result;
            }
        } else {
            result.id = Date.now();
            records.unshift(result);
        }

        localStorage.setItem(DUBLEKS_STORAGE_KEY, JSON.stringify(records));

        dubleksClearForm();
        dubleksLoadRecords();
        showDubleksMessage("Kayƒ±t ba≈üarƒ±yla i≈ülendi!", "success");
    }

    function dubleksLoadRecords() {
        const raw = JSON.parse(localStorage.getItem(DUBLEKS_STORAGE_KEY)) || [];
        const records = raw.map(r => normalizeDubleksRecord(r));
        const container = document.getElementById('dubleksRecordsList');

        if (records.length === 0) {
            container.innerHTML = '<p style="color: #6b7280; text-align: center;">Hen√ºz kayƒ±tlƒ± analiz yok.</p>';
            return;
        }

        let html = '';
        records.forEach(rec => {
            const y = rec.yasalCalc ?? calcSection(rec.yasal);
            const m = rec.mevcutCalc ?? calcSection(rec.mevcut);
            const grand = rec.grandTotal ?? (y.total + m.total);

            html += `
                <div class="card record-item">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                        <h4 style="margin:0;">${rec.date}</h4>
                        <span style="background:#dbeafe; color:#1e40af; padding:2px 8px; border-radius:4px; font-size:0.9rem; font-weight:bold;">
                            Genel: ${TR_INT.format(grand)} TL
                        </span>
                    </div>

                    <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.9rem;">
                        <div>
                            <strong>Yasal:</strong><br>
                            Normal: ${TR_FORMAT.format(rec.yasal.normalArea)} m¬≤ √ó ${TR_INT.format(rec.yasal.unitValue)} = <strong>${TR_INT.format(y.normalCalc)} TL</strong><br>
                            √áatƒ±: ${TR_FORMAT.format(rec.yasal.roofArea)} m¬≤ √ó (%${TR_FORMAT.format(rec.yasal.roofRatio)}) = <strong>${TR_INT.format(y.roofCalc)} TL</strong><br>
                            Teras: ${TR_FORMAT.format(rec.yasal.terasArea)} m¬≤ √ó (%${TR_FORMAT.format(rec.yasal.terasRatio)}) = <strong>${TR_INT.format(y.terasCalc)} TL</strong><br>
                            <u>Yasal Toplam:</u> <strong>${TR_INT.format(y.total)} TL</strong>
                        </div>

                        <div>
                            <strong>Mevcut:</strong><br>
                            Normal: ${TR_FORMAT.format(rec.mevcut.normalArea)} m¬≤ √ó ${TR_INT.format(rec.mevcut.unitValue)} = <strong>${TR_INT.format(m.normalCalc)} TL</strong><br>
                            √áatƒ±: ${TR_FORMAT.format(rec.mevcut.roofArea)} m¬≤ √ó (%${TR_FORMAT.format(rec.mevcut.roofRatio)}) = <strong>${TR_INT.format(m.roofCalc)} TL</strong><br>
                            Teras: ${TR_FORMAT.format(rec.mevcut.terasArea)} m¬≤ √ó (%${TR_FORMAT.format(rec.mevcut.terasRatio)}) = <strong>${TR_INT.format(m.terasCalc)} TL</strong><br>
                            <u>Mevcut Toplam:</u> <strong>${TR_INT.format(m.total)} TL</strong>
                        </div>
                    </div>

                    <div class="record-actions">
                        <button class="btn-edit" onclick="dubleksEdit(${rec.id})">D√ºzenle</button>
                        <button class="btn-danger" onclick="dubleksDelete(${rec.id})">Sil</button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function dubleksEdit(id) {
        hideDubleksMessage();

        const records = JSON.parse(localStorage.getItem(DUBLEKS_STORAGE_KEY)) || [];
        const raw = records.find(r => r.id === id);
        if (!raw) return;

        const rec = normalizeDubleksRecord(raw);

        document.getElementById('dubleksEditId').value = rec.id;

        document.getElementById('yasalNormalArea').value = rec.yasal.normalArea || '';
        document.getElementById('yasalUnitValue').value  = rec.yasal.unitValue || '';
        document.getElementById('yasalRoofArea').value   = rec.yasal.roofArea || '';
        document.getElementById('yasalRoofRatio').value  = rec.yasal.roofRatio || '';
        document.getElementById('yasalTerasArea').value  = rec.yasal.terasArea || '';
        document.getElementById('yasalTerasRatio').value = rec.yasal.terasRatio || '';

        document.getElementById('mevcutNormalArea').value = rec.mevcut.normalArea || '';
        document.getElementById('mevcutUnitValue').value  = rec.mevcut.unitValue || '';
        document.getElementById('mevcutRoofArea').value   = rec.mevcut.roofArea || '';
        document.getElementById('mevcutRoofRatio').value  = rec.mevcut.roofRatio || '';
        document.getElementById('mevcutTerasArea').value  = rec.mevcut.terasArea || '';
        document.getElementById('mevcutTerasRatio').value = rec.mevcut.terasRatio || '';

        dubleksRecalcLive();
        document.getElementById('dubleksFormCard').scrollIntoView({ behavior: 'smooth' });
    }

    function dubleksDelete(id) {
        hideDubleksMessage();
        if (!confirm("Bu kaydƒ± silmek istediƒüinize emin misiniz?")) return;

        let records = JSON.parse(localStorage.getItem(DUBLEKS_STORAGE_KEY)) || [];
        records = records.filter(r => r.id !== id);
        localStorage.setItem(DUBLEKS_STORAGE_KEY, JSON.stringify(records));

        dubleksLoadRecords();
        showDubleksMessage("Kayƒ±t silindi.", "success");
    }

    function dubleksClearForm() {
        hideDubleksMessage();

        document.getElementById('dubleksEditId').value = '';

        document.getElementById('yasalNormalArea').value = '';
        document.getElementById('yasalUnitValue').value  = '';
        document.getElementById('yasalRoofArea').value   = '';
        document.getElementById('yasalRoofRatio').value  = '';
        document.getElementById('yasalTerasArea').value  = '';
        document.getElementById('yasalTerasRatio').value = '';

        document.getElementById('mevcutNormalArea').value = '';
        document.getElementById('mevcutUnitValue').value  = '';
        document.getElementById('mevcutRoofArea').value   = '';
        document.getElementById('mevcutRoofRatio').value  = '';
        document.getElementById('mevcutTerasArea').value  = '';
        document.getElementById('mevcutTerasRatio').value = '';

        dubleksRecalcLive();
    }

    // -----------------------------
    // SEKME KONTROL√ú
    // -----------------------------
    function setActiveTab(which) {
        const btn1 = document.getElementById('tabKatAnaliziBtn');
        const btn2 = document.getElementById('tabDubleksBtn');
        const p1 = document.getElementById('panelKatAnalizi');
        const p2 = document.getElementById('panelDubleks');

        if (which === 'kat') {
            btn1.classList.add('active'); btn2.classList.remove('active');
            p1.classList.add('active');  p2.classList.remove('active');
        } else {
            btn2.classList.add('active'); btn1.classList.remove('active');
            p2.classList.add('active');  p1.classList.remove('active');
        }
    }

    function setDubleksSubtab(which) {
        const yBtn = document.getElementById('subtabYasalBtn');
        const mBtn = document.getElementById('subtabMevcutBtn');
        const yP = document.getElementById('panelYasal');
        const mP = document.getElementById('panelMevcut');

        if (which === 'yasal') {
            yBtn.classList.add('active'); mBtn.classList.remove('active');
            yP.classList.add('active');  mP.classList.remove('active');
        } else {
            mBtn.classList.add('active'); yBtn.classList.remove('active');
            mP.classList.add('active');  yP.classList.remove('active');
        }
    }

    // Sayfa y√ºklendiƒüinde
    document.addEventListener('DOMContentLoaded', () => {
        // Kat Analizi init
        updateFloorOptions();
        loadRecords();

        const askingPriceInput = document.getElementById('askingPrice');
        const bargainMarginInput = document.getElementById('bargainMargin');
        const basementCountInput = document.getElementById('basementCount');
        const normalCountInput = document.getElementById('normalCount');
        const addFloorBtn = document.getElementById('addFloorBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const form = document.getElementById('analysisForm');

        if (askingPriceInput) {
            askingPriceInput.addEventListener('input', () => { calculateInstantPrice(); katRecalcLive(); });
        }
        if (bargainMarginInput) {
            bargainMarginInput.addEventListener('input', () => { calculateInstantPrice(); katRecalcLive(); });
        }
        if (basementCountInput) basementCountInput.addEventListener('input', updateFloorOptions);
        if (normalCountInput) normalCountInput.addEventListener('input', updateFloorOptions);
        if (addFloorBtn) addFloorBtn.addEventListener('click', () => addFloorRow());
        if (clearFormBtn) clearFormBtn.addEventListener('click', clearForm);

        // ‚úÖ floor satƒ±rlarƒ±nda input deƒüi≈üince canlƒ± hesap g√ºncelle (delegation)
        const floorsContainer = document.getElementById('floorsContainer');
        if (floorsContainer) {
            floorsContainer.addEventListener('input', (e) => {
                if (e.target && (e.target.classList.contains('floor-area') || e.target.classList.contains('floor-ratio'))) {
                    katRecalcLive();
                }
            });
        }

        if (form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                saveRecord();
            });
        }

        // ‚úÖ Kat Analizi canlƒ± hesap ilk √ßizim
        katRecalcLive();

        // Dubleks init
        dubleksLoadRecords();
        dubleksRecalcLive();

        const dInputs = [
            'yasalNormalArea','yasalUnitValue','yasalRoofArea','yasalRoofRatio','yasalTerasArea','yasalTerasRatio',
            'mevcutNormalArea','mevcutUnitValue','mevcutRoofArea','mevcutRoofRatio','mevcutTerasArea','mevcutTerasRatio'
        ].map(id => document.getElementById(id));

        dInputs.forEach(inp => { if (inp) inp.addEventListener('input', dubleksRecalcLive); });

        const dForm = document.getElementById('dubleksForm');
        const dClear = document.getElementById('dubleksClearBtn');

        if (dClear) dClear.addEventListener('click', dubleksClearForm);
        if (dForm) {
            dForm.addEventListener('submit', (e) => {
                e.preventDefault();
                dubleksSave();
            });
        }

        // √úst sekmeler
        document.getElementById('tabKatAnaliziBtn').addEventListener('click', () => setActiveTab('kat'));
        document.getElementById('tabDubleksBtn').addEventListener('click', () => setActiveTab('dubleks'));

        // Dubleks alt sekmeler
        document.getElementById('subtabYasalBtn').addEventListener('click', () => setDubleksSubtab('yasal'));
        document.getElementById('subtabMevcutBtn').addEventListener('click', () => setDubleksSubtab('mevcut'));
    });
</script>

</body>
</html>
