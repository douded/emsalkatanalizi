<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kat Analizi ve ƒ∞ndirgeme Programƒ± v2.3</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --danger: #dc2626;
            --success: #16a34a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1, h2, h3 { 
            color: var(--secondary); 
            margin-bottom: 15px; 
        }
        
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group { margin-bottom: 15px; }
        label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 5px; 
            font-size: 0.9rem; 
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input:focus { 
            outline: 2px solid var(--primary); 
            border-color: transparent; 
        }

        .row { 
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap; 
        }
        .col { 
            flex: 1; 
            min-width: 200px; 
        }

        button {
            cursor: pointer;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        
        .btn-primary { 
            background-color: var(--primary); 
            color: white; 
            width: 100%; 
            font-size: 1.1rem; 
        }
        .btn-secondary { 
            background-color: #64748b; 
            color: white; 
        }
        .btn-danger { 
            background-color: var(--danger); 
            color: white; 
            padding: 5px 10px; 
            font-size: 0.8rem; 
        }
        .btn-edit { 
            background-color: var(--primary); 
            color: white; 
            padding: 5px 10px; 
            font-size: 0.8rem; 
            margin-right: 5px; 
        }
        .btn-warning {
            background-color: #ef4444;
            color: white;
        }
        
        .floor-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            background: #f8fafc;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }

        .floor-row h4 { 
            margin: 0 0 5px 0; 
            grid-column: 1 / -1; 
            font-size: 0.9rem; 
            color: var(--secondary); 
        }

        @media (max-width: 600px) {
            .floor-row { 
                grid-template-columns: 1fr; 
            }
            .btn-danger { 
                width: 100%; 
                margin-top: 5px; 
            }
        }

        .result-box {
            background-color: #ecfdf5;
            border: 1px solid #10b981;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* Anlƒ±k sonu√ß ve mesaj alanƒ± stili */
        .instant-result {
            margin-top: 10px;
            padding: 10px;
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            border-radius: 6px;
            font-weight: bold;
            display: none;
        }
        
        .record-item {
            border-left: 4px solid var(--primary);
            padding-left: 15px;
            margin-bottom: 15px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            position: relative;
        }
        
        .record-actions { 
            margin-top: 10px; 
            text-align: right; 
        }

        .divider {
            border: 0;
            border-top: 1px solid #e5e7eb;
            margin: 20px 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üèóÔ∏è Kat Analizi Programƒ±</h1>

    <section class="card" id="inputForm">
        <h3>Yeni Analiz Olu≈ütur</h3>

        <!-- Sayfa i√ßi mesaj kutusu -->
        <div id="messageBox" class="instant-result" aria-live="polite" style="display:none;"></div>

        <form id="analysisForm">
            <input type="hidden" id="editId">
            
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="askingPrice">ƒ∞stenilen Fiyat (TL)</label>
                        <input type="number" id="askingPrice" placeholder="√ñrn: 10000000">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="bargainMargin">Pazarlƒ±k Payƒ± (%) - Opsiyonel</label>
                        <input type="number" id="bargainMargin" placeholder="Bo≈ü bƒ±rakƒ±lƒ±rsa fiyat baz alƒ±nƒ±r">
                    </div>
                </div>
            </div>

            <div id="instantPriceDisplay" class="instant-result"></div>

            <hr class="divider">

            <h4 style="color: var(--text);">Bina Kat Yapƒ±landƒ±rmasƒ±</h4>
            <div class="row" style="background: #eff6ff; padding: 15px; border-radius: 8px; border: 1px solid #bfdbfe;">
                <div class="col">
                    <div class="form-group">
                        <label for="basementCount">Bodrum Kat Sayƒ±sƒ±</label>
                        <input type="number" id="basementCount" value="1" min="0">
                        <small style="color:#666; font-size:0.8em">Ka√ß adet bodrum kat var?</small>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="normalCount">Normal Kat Sayƒ±sƒ±</label>
                        <input type="number" id="normalCount" value="1" min="1">
                        <small style="color:#666; font-size:0.8em">Ka√ß adet normal kat var?</small>
                    </div>
                </div>
            </div>

            <br>

            <div class="form-group">
                <label for="floorSelector">Listeye Kat Ekle (Hesaplamaya Dahil Et):</label>
                <div style="display: flex; gap: 10px;">
                    <select id="floorSelector">
                    </select>
                    <button type="button" id="addFloorBtn" class="btn-secondary" style="width: auto; white-space: nowrap;">+ Ekle</button>
                </div>
            </div>

            <div id="floorsContainer"></div>

            <div id="calculationResult" class="result-box" style="display:none;"></div>

            <div style="margin-top: 20px;">
                <button type="submit" class="btn-primary">Kaydet ve Listeye Ekle</button>
                <button type="button" id="clearFormBtn" class="btn-secondary btn-warning" style="margin-top: 10px; width: 100%;">Formu Temizle / ƒ∞ptal</button>
            </div>
        </form>
    </section>

    <section class="card">
        <h3>Kaydedilen Analizler</h3>
        <div id="recordsList" aria-live="polite">
            <p style="color: #6b7280; text-align: center;">Hen√ºz kayƒ±tlƒ± analiz yok.</p>
        </div>
    </section>
</div>

<script>
    // Global sabitler
    const TR_FORMAT = new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const TR_INT = new Intl.NumberFormat('tr-TR', { maximumFractionDigits: 0 });
    const STORAGE_KEY = 'katAnaliziRecordsV2';

    // Ortak fiyat yuvarlama fonksiyonu
    function getRoundedPrice(price, marginInput) {
        let roundedPrice = price;
        let margin = 0;

        if (marginInput !== '' && !isNaN(parseFloat(marginInput))) {
            margin = parseFloat(marginInput);
            const discountedPrice = price * (1 - (margin / 100));
            roundedPrice = Math.round(discountedPrice / 100000) * 100000;
        }

        return { roundedPrice, margin };
    }

    // Mesaj g√∂sterme fonksiyonu (alert yerine)
    function showMessage(message, type = 'info') {
        const box = document.getElementById('messageBox');
        box.textContent = message;
        box.style.display = 'block';

        if (type === 'error') {
            box.style.backgroundColor = '#fee2e2';
            box.style.borderColor = '#fecaca';
            box.style.color = '#b91c1c';
        } else if (type === 'success') {
            box.style.backgroundColor = '#ecfdf5';
            box.style.borderColor = '#bbf7d0';
            box.style.color = '#166534';
        } else {
            box.style.backgroundColor = '#eff6ff';
            box.style.borderColor = '#bfdbfe';
            box.style.color = '#1e40af';
        }
    }

    function hideMessage() {
        const box = document.getElementById('messageBox');
        box.style.display = 'none';
    }

    // Anlƒ±k Fiyat Hesaplama
    function calculateInstantPrice() {
        const price = parseFloat(document.getElementById('askingPrice').value);
        const marginInput = document.getElementById('bargainMargin').value;
        const displayDiv = document.getElementById('instantPriceDisplay');

        if (isNaN(price)) {
            displayDiv.style.display = 'none';
            return;
        }

        const { roundedPrice } = getRoundedPrice(price, marginInput);

        displayDiv.innerHTML = `Hesaplanan Deƒüer (Yuvarlanmƒ±≈ü): ${TR_INT.format(roundedPrice)} TL`;
        displayDiv.style.display = 'block';
    }

    // Kat Se√ßeneklerini Dinamik G√ºncelleme
    function updateFloorOptions() {
        const basementCount = parseInt(document.getElementById('basementCount').value) || 0;
        const normalCount = parseInt(document.getElementById('normalCount').value) || 1;
        const selector = document.getElementById('floorSelector');
        
        selector.innerHTML = '<option value="" disabled selected>Kat Se√ßiniz...</option>';

        for (let i = basementCount; i >= 1; i--) {
            const val = `${i}.Bodrum Kat`;
            const option = document.createElement('option');
            option.value = val;
            option.text = val;
            selector.add(option);
        }

        selector.add(new Option("Zemin Kat", "Zemin Kat"));
        selector.add(new Option("Asma Kat", "Asma Kat"));

        for (let i = 1; i <= normalCount; i++) {
            const val = `${i}.Normal Kat`;
            const option = document.createElement('option');
            option.value = val;
            option.text = val;
            selector.add(option);
        }

        selector.add(new Option("√áatƒ± Kat", "√áatƒ± Kat"));
    }

    // Listeye yeni kat satƒ±rƒ± ekleme
    function addFloorRow(floorName = null, area = '', ratio = '') {
        const selector = document.getElementById('floorSelector');
        const selectedFloor = floorName || selector.value;

        if (!selectedFloor) {
            showMessage("L√ºtfen √∂nce listeden bir kat se√ßiniz.", 'error');
            return;
        }

        const container = document.getElementById('floorsContainer');
        const rowId = Date.now() + Math.random();

        const div = document.createElement('div');
        div.className = 'floor-row';
        div.id = `row-${rowId}`;
        div.dataset.floorName = selectedFloor;

        div.innerHTML = `
            <div><strong>${selectedFloor}</strong></div>
            <div>
                <input type="number" class="floor-area" placeholder="Alan (m¬≤)" value="${area}">
            </div>
            <div>
                <input type="number" class="floor-ratio" placeholder="ƒ∞nd. Oranƒ±" value="${ratio}">
            </div>
            <div>
                <button type="button" class="btn-danger" onclick="removeFloorRow('${rowId}')">Sil</button>
            </div>
        `;

        container.appendChild(div);
        
        if (!floorName) selector.value = "";
    }

    function removeFloorRow(id) {
        const row = document.getElementById(`row-${id}`);
        if (row) row.remove();
    }

    // Hesaplama (Kaydet butonu i√ßin)
    function performCalculation() {
        hideMessage();

        const price = parseFloat(document.getElementById('askingPrice').value);
        const marginInput = document.getElementById('bargainMargin').value;
        const bCount = document.getElementById('basementCount').value;
        const nCount = document.getElementById('normalCount').value;
        
        if (isNaN(price)) {
            showMessage("L√ºtfen ƒ∞stenilen Fiyat bilgisini giriniz.", 'error');
            return null;
        }

        const { roundedPrice, margin } = getRoundedPrice(price, marginInput);

        const rows = document.querySelectorAll('.floor-row');
        if (rows.length === 0) {
            showMessage("L√ºtfen en az bir kat ekleyiniz.", 'error');
            return null;
        }

        let totalReducedArea = 0;
        const floorDetails = [];

        for (const row of rows) {
            const name = row.dataset.floorName;
            const area = parseFloat(row.querySelector('.floor-area').value);
            const ratio = parseFloat(row.querySelector('.floor-ratio').value);

            if (isNaN(area) || isNaN(ratio) || ratio <= 0) {
                showMessage(`${name} i√ßin ge√ßerli alan ve indirgeme oranƒ± giriniz.`, 'error');
                return null;
            }

            const reducedArea = area / ratio;
            totalReducedArea += reducedArea;

            floorDetails.push({
                name: name,
                area: area,
                ratio: ratio,
                reduced: reducedArea
            });
        }

        let unitValue = 0;
        if (totalReducedArea > 0) {
            unitValue = roundedPrice / totalReducedArea;
        }

        return {
            price,
            margin,
            bCount,
            nCount,
            roundedPrice, 
            floorDetails,
            totalReducedArea,
            unitValue,
            date: new Date().toLocaleString('tr-TR')
        };
    }

    // Kaydetme
    function saveRecord() {
        const result = performCalculation();
        if (!result) return;

        let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const editId = document.getElementById('editId').value;

        if (editId) {
            const index = records.findIndex(r => r.id == editId);
            if (index > -1) {
                result.id = Number(editId);
                records[index] = result;
            }
        } else {
            result.id = Date.now();
            records.unshift(result);
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        
        clearForm();
        loadRecords();
        showMessage("Kayƒ±t ba≈üarƒ±yla i≈ülendi!", 'success');
    }

    // Listeyi Y√ºkleme
    function loadRecords() {
        const records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const container = document.getElementById('recordsList');
        
        if (records.length === 0) {
            container.innerHTML = '<p style="color: #6b7280; text-align: center;">Hen√ºz kayƒ±tlƒ± analiz yok.</p>';
            return;
        }

        let html = '';
        records.forEach(rec => {
            html += `
                <div class="card record-item">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <h4 style="margin:0;">${rec.date}</h4>
                        <span style="background:#dbeafe; color:#1e40af; padding:2px 8px; border-radius:4px; font-size:0.9rem; font-weight:bold;">
                            ${TR_FORMAT.format(rec.unitValue)} TL/m¬≤
                        </span>
                    </div>
                    
                    <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.9rem;">
                        <div>
                            <strong>ƒ∞stenen:</strong> ${TR_INT.format(rec.price)} TL<br>
                            <strong>Pazarlƒ±k:</strong> %${rec.margin}<br>
                            <strong>Hesaplanan:</strong> ${TR_INT.format(rec.roundedPrice)} TL
                        </div>
                        <div>
                            <strong>Bina Yapƒ±sƒ±:</strong> ${rec.bCount} Bodrum, ${rec.nCount} Normal<br>
                            <strong>Top. ƒ∞nd. Alan:</strong> ${TR_FORMAT.format(rec.totalReducedArea)} m¬≤
                        </div>
                    </div>

                    <div style="margin-top:10px; background:#fff; padding:5px; border:1px dashed #ccc; font-size:0.85rem;">
                        <strong>Detaylar:</strong><br>
                        ${rec.floorDetails.map(f => `${f.name}: ${f.area}m¬≤ / ${f.ratio} = ${TR_FORMAT.format(f.reduced)}`).join('<br>')}
                    </div>

                    <div class="record-actions">
                        <button class="btn-edit" onclick="editRecord(${rec.id})">D√ºzenle</button>
                        <button class="btn-danger" onclick="deleteRecord(${rec.id})">Sil</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // D√ºzenleme
    function editRecord(id) {
        hideMessage();

        const records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const rec = records.find(r => r.id === id);
        if (!rec) return;

        document.getElementById('editId').value = rec.id;
        document.getElementById('askingPrice').value = rec.price;
        document.getElementById('bargainMargin').value = rec.margin === 0 ? '' : rec.margin;
        
        calculateInstantPrice();

        document.getElementById('basementCount').value = rec.bCount || 1;
        document.getElementById('normalCount').value = rec.nCount || 1;
        
        updateFloorOptions();

        document.getElementById('floorsContainer').innerHTML = '';
        rec.floorDetails.forEach(f => {
            addFloorRow(f.name, f.area, f.ratio);
        });

        // Ba≈ülƒ±k d√ºzenleme modu g√∂stergesi (opsiyonel)
        const title = document.querySelector('#inputForm h3');
        if (title) title.textContent = 'Analiz D√ºzenle';

        document.getElementById('inputForm').scrollIntoView({ behavior: 'smooth' });
    }

    function deleteRecord(id) {
        hideMessage();
        if (!confirm("Bu kaydƒ± silmek istediƒüinize emin misiniz?")) return;
        let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        records = records.filter(r => r.id !== id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        loadRecords();
        showMessage("Kayƒ±t silindi.", 'success');
    }

    function clearForm() {
        hideMessage();

        document.getElementById('editId').value = '';
        document.getElementById('askingPrice').value = '';
        document.getElementById('bargainMargin').value = '';
        document.getElementById('instantPriceDisplay').style.display = 'none';
        
        document.getElementById('basementCount').value = '1';
        document.getElementById('normalCount').value = '1';
        updateFloorOptions(); 

        document.getElementById('floorSelector').value = '';
        document.getElementById('floorsContainer').innerHTML = '';
        document.getElementById('calculationResult').style.display = 'none';

        const title = document.querySelector('#inputForm h3');
        if (title) title.textContent = 'Yeni Analiz Olu≈ütur';
    }

    // Sayfa y√ºklendiƒüinde
    document.addEventListener('DOMContentLoaded', () => {
        updateFloorOptions();
        loadRecords();

        const askingPriceInput = document.getElementById('askingPrice');
        const bargainMarginInput = document.getElementById('bargainMargin');
        const basementCountInput = document.getElementById('basementCount');
        const normalCountInput = document.getElementById('normalCount');
        const addFloorBtn = document.getElementById('addFloorBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const form = document.getElementById('analysisForm');

        if (askingPriceInput) {
            askingPriceInput.addEventListener('input', calculateInstantPrice);
        }
        if (bargainMarginInput) {
            bargainMarginInput.addEventListener('input', calculateInstantPrice);
        }
        if (basementCountInput) {
            basementCountInput.addEventListener('input', updateFloorOptions);
        }
        if (normalCountInput) {
            normalCountInput.addEventListener('input', updateFloorOptions);
        }
        if (addFloorBtn) {
            addFloorBtn.addEventListener('click', () => addFloorRow());
        }
        if (clearFormBtn) {
            clearFormBtn.addEventListener('click', clearForm);
        }
        if (form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                saveRecord();
            });
        }
    });
</script>

</body>
</html>
